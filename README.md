# kyoyoZemi2025

ダイナミクセルMx28を動かすためのサンプルプログラムです．
Windowsで動かすことを想定しています．

## 事前準備
以下の2つのソフトウェアを入れてください．

### ダイナミクセルウィザード
こちらのサイトに従って，ダイナミクセルウィザードをインストールしてください．
このソフトを使えば，ダイナミクセルを簡単に動かすことができます．
https://emanual.robotis.com/docs/en/software/dynamixel/dynamixel_wizard2/

ソフトウェアの使い方などは，日本語だと以下のサイトがまとまっています．
https://www.besttechnology.co.jp/modules/knowledge/?DYNAMIXEL%20basic%20tutorial#q270593c

使い方は最小限は授業中に教えますので，インストールまでできればOKです．

### C++プログラミング環境

C++言語のプログラムを作成・実行できる環境を作ってください．やり方は問いません．
このページでは，VS Code＋GCC with MinGWというやり方を紹介します．

以下の，マイクロソフトの公式サイトの案内に従ってVSCODEとMinGWをインストールしてください．
https://code.visualstudio.com/docs/cpp/config-mingw
（Prerequisites，Installing the MinGW-w64 toolchain，Check your MinGW installation　の3つの節をやってください）


## ダイナミクセルを動かすためのハードウェアの準備

ＵＳＢダイナミクセルをＰＣに接続してください
そして，ダイナミクセルに電源を与えてください．


## プログラムの実行
### 実行前の確認作業
ダイナミクセルと通信するポートが何番かを確かめます．
図のように，windows下部にある検索枠に，`devmng` と打ち込みます．すると，「デバイスマネージャー」が見つかりますので，それをクリックしてデバイスマネージャを立ち上げてください．

<img width="600" src="Figs/devmng1.png">

> [!NOTE]
> デバイスマネージャは，PCに接続されているデバイスを管理するマネージャです．USB接続の機器など接続すればここに出てきますので，ＰＣにデバイスを挿しても認識しない場合などはこれを確認すると良いです．


さて，デバイスマネージャを立ち上げると以下のような画面が出てきます．
下にスクロールしていって，「ポート（COMとLPT）」を探して，左側の「＞」印を押して内部の階層が見えるようにしてください．
「USBSerialPort（COM？）」というのが出てくると思います．このCOM番号を覚えておいてください．図の場合はCOM5です．
（複数ポートが出てくるときは，USBダイナミクセルを抜いて消えるポートを確認するなどして，どれがUSBダイナミクセルに対応しているかを特定してください．）

<img width="600" src="Figs/devmng2.png">

> [!NOTE]
> ダイナミクセルを動かすためには，ＰＣから指令を送る必要があります．この指令の通信には，シリアル通信と呼ばれる規格を使っています．
> この通信を行う際には，ポート番号（データの出入り口番号）を指定して通信してやる必要があります．

さらに，PCとダイナミクセルとの通信速度を上げるための設定をします．下の図のように，
1. 「USBSerialPort（COM？）」をダブルクリック
1. 出てくるウインドウ「USBSerialPort（COM？）のプロパティ」で，「ポートの設定」　タブを選択
2. 出てくるタブで，「詳細設定」　のボタンをクリック
3. 出てくるウインドウ「ＣＯＭ？の詳細設定」において，「待ち時間（ｍｓｅｃ）」を　「　１６　」　＝＞「　１　」に変更する．

<img width="800" src="Figs/devmng3.png">

> [!NOTE]
> デフォルトでは，パソコンの処理量を減らすため，得た通信データをバッファ（入れ物）にためて１６ｍｓおきに取り出すようになっています．つまり，ダイナミクセルとの通信に１６ｍｓの遅れが発生します．
> ダイナミクセルをなるべく遅延なく動かすために，この待ち時間を１ｍｓに変更する処理をしました．

### 実行前の準備
このリポジトリに上がっているプログラム一式をダウンロードして，実行する準備をします．
まず，このリポジトリ一式をダウンロードします．以下のように，このサイトの右上の緑ボタンを開いて，ZIPファイルでダウンロードするのが簡単です．
<img width="800" src="Figs/git1.png">

そのあと，フォルダを解凍して，codeフォルダの中身をすべて，自分のパソコン内にフォルダを作っておいてください．
ここでは，写真の例では，SampleDyna　というフォルダ内部にすべてのファイルを置きました．（写真では関係ないファイルも入っていますが，気にしないでください）
<img width="700" src="Figs/folder.png">

次に，プログラムファイルを開いて，自分のPCに合わせた設定をします（通信ポートやダイナミクセルＩＤなど）．

visual stdio code  を使って，プログラムファイルを開いてみましょう．
visual stdio code　を開いて，左上の　ファイルー＞フォルダを開く　から，先ほど作ったフォルダを開きます．
そうすると左側にエクスプローラが表示されて，フォルダ内のファイル等が出てきます．

まず，main_test_commSpeed.cppをダブルクリックして開きます．
ファイルを開いたら，以下の場所を修正します（図も参考に）
- １４行目の，`"\\\\.\\COM?"` の部分を，確認した通信ポートの番号に変更します． 例　`"\\\\.\\COM3"`
- ２５行目の　`int ID = ?` の部分で，？に，ダイナミクセルのＩＤ番号を入れてください（シールを張ってます）．　例　`int ID =  12`
これらの修正が出来たら，ファイルを上書き保存します．
左上の　ファイルー＞保存　をクリックするか，ショートカットキー　Ctr + s で保存しましょう．

<img width="700" src="Figs/program1.png">

同様に，main_test_ctrLoop.cppを開きます．ダブルクリックすると，VisualStudioCodeで開けると思います．
ファイルを開いたら，以下の図の場所を修正します（図も参考に）
- １４行目の，`"\\\\.\\COM?"` の部分を，確認した通信ポートの番号に変更します． 例　`"\\\\.\\COM3"`
- ２５行目の　`int ID = ?` の部分で，？に，ダイナミクセルのＩＤ番号を入れてください（シールを張ってます）．　例　`int ID =  12`
これらの修正が出来たら，同様にファイルを上書き保存します．
<img width="700" src="Figs/program2.png">

これで準備は完了です．
> [!NOTE]
> .cpp という拡張子は初めてみると思いますが，これが，C＋＋言語で書かれたプログラムの拡張子です．
> .h という拡張子のファイルもあります．基本的には　.cpp　ファイルにプログラム本体がかかれており，.h　ファイルには関数（この関数には，一連の作業がまとめて書かれてある）などが定義されています．

### 通信のテストプログラムのコンパイルと実行
プログラムをコンパイルして動かします．
> [!NOTE]
> コンパイルというのは，人間に読める言語で書かれたプログラムを，PCで実行するための機械語に翻訳する作業と思ってください．
> プログラム言語の文法が間違っていたりすると，コンパイルエラーが出ます．プログラムファイルを修正するたびにコンパイルが必要です．

VisualStudioCodeの上の部分から，「ターミナル」と書かれた部分を選択して，「新しいターミナル」をクリックします．すると，下側にウインドウが増えると思います．　
その部分に，以下のコマンドをコピペして，エンターボタンを押してください．

```bash
g++ -o testComm.exe  main_test_commSpeed.cpp  serial.cpp  amBasic.cpp  -lstdc++
```

図のように，特にエラーがでることなく次の行が出てこれば成功です．
うまくいけば，左側のエクスプローラに，`testComm.exe` というファイルができていると思います．

<img width="700" src="Figs/program3.png">

> [!NOTE]
> ターミナルとは，PCに文字で指示を行うためのプログラムです．windows では コマンドプロンプト　とも呼ばれます．
> ここでは， g++ を使って，main_test_commSpeed.cpp  serial.cpp  amBasic.cpp　のファイルをコンパイルして，testComm.exe　という実行ファイルを作ってというコマンドを手打ちしました．
> また，.exe　ファイルは実行ファイルと呼ばれ，これをダブルクリックするとＰＣ内部で，プログラムに書いた処理が行われます．

さて，実行ファイルを実行してみましょう．
実行の仕方は２つあります．簡単なやり方は，フォルダ内にある　testComm.exe　をダブルクリックすれば実行できます（VisualStudioCodeのエクスプローラでダブルクリックするのではだめで，いわゆるファイルエクスプローラ（フォルダを開いて）からダブルクリックしてください．）
もう一つのやり方は，ターミナルで以下のコマンドを打つことです．
```bash
./testComm.exe
```
`./`が実行してください　というコマンドに対応しています．

実行してやると，
`Start program for checking dynamixel movement`
と表示されるので，エンターキーを押してください．
ポート番号が正常に設定できていれば，`Success to Open port`と表示され，１５秒後にダイナミクセルが動き始めます．
１秒おきに，ダイナミクセルの現在角度や，１００回の通信にかかった時間などが表示されると思います．


### 制御サンプルプログラムのコンパイルと実行
ターミナルにてプログラムファイルと同じ階層にて，以下のコマンドを売ってください．
```bash
g++ -o testComm.exe  main_test_ctrLoop.cpp  serial.cpp  amBasic.cpp  -lstdc++
```


